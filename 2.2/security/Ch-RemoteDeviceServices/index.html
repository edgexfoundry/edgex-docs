
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for use of EdgeX Foundry">
      
      
        <meta name="author" content="Michael Johanson">
      
      
        <link rel="canonical" href="https://edgexfoundry.github.io/edgex-docs/security/Ch-RemoteDeviceServices/">
      
      <link rel="icon" href="../../assets/logo_edgex.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.15">
    
    
      
        <title>Remote Device Services in Secure Mode - EdgeX Foundry Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.c382b1dc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/version-select.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/branding.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/edgey.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/newexample.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#remote-device-services-in-secure-mode" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="EdgeX Foundry Documentation" class="md-header__button md-logo" aria-label="EdgeX Foundry Documentation" data-md-component="logo">
      
  <img src="../../assets/logo_edgex_white.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EdgeX Foundry Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Remote Device Services in Secure Mode
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/edgexfoundry/edgex-go" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    edgex/edgex-go
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        Introduction
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../getting-started/" class="md-tabs__link">
        Getting Started
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../Ch-Security/" class="md-tabs__link md-tabs__link--active">
        Security
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../microservices/general/" class="md-tabs__link">
        Microservices
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../examples/" class="md-tabs__link">
        Examples and Tutorials
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../api/Ch-APIIntroduction/" class="md-tabs__link">
        API Reference
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../design/" class="md-tabs__link">
        Architectural Decision Records
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../general/Definitions/" class="md-tabs__link">
        Reference
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="EdgeX Foundry Documentation" class="md-nav__button md-logo" aria-label="EdgeX Foundry Documentation" data-md-component="logo">
      
  <img src="../../assets/logo_edgex_white.png" alt="logo">

    </a>
    EdgeX Foundry Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/edgexfoundry/edgex-go" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    edgex/edgex-go
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Introduction
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Introduction" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Introduction
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../V2TopLevelMigration/" class="md-nav__link">
        V2 Migration Guide
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/quick-start/" class="md-nav__link">
        Quick Start
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3">
          Users
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Users" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Users
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/Ch-GettingStartedUsers/" class="md-nav__link">
        Getting Started as a User
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/Ch-GettingStartedDockerUsers/" class="md-nav__link">
        Getting Started using Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/Ch-GettingStartedSnapUsers/" class="md-nav__link">
        Getting Started using Snaps
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_4">
          Developers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Developers" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          Developers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/Ch-GettingStartedDevelopers/" class="md-nav__link">
        Getting Started as a Developer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/Ch-GettingStartedGoDevelopers/" class="md-nav__link">
        Getting Started - Go Developers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/Ch-GettingStartedCDevelopers/" class="md-nav__link">
        Getting Started - C Developers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/Ch-GettingStartedHybrid/" class="md-nav__link">
        Working in a Hybrid Environment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/ApplicationFunctionsSDK/" class="md-nav__link">
        Application Functions SDK
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4_6" type="checkbox" id="__nav_2_4_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_4_6">
          Device Services
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Device Services" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_4_6">
          <span class="md-nav__icon md-icon"></span>
          Device Services
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/Ch-GettingStartedSDK/" class="md-nav__link">
        Device Service SDK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/Ch-GettingStartedSDK-C/" class="md-nav__link">
        C SDK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/Ch-GettingStartedSDK-Go/" class="md-nav__link">
        Golang SDK
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/Ch-GettingStartedUsersNexus/" class="md-nav__link">
        Getting Docker Images from EdgeX Nexus Repository
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" type="checkbox" id="__nav_2_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_5">
          Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tools" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/tools/Ch-CommandLineInterface/" class="md-nav__link">
        Command Line Interface (CLI)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/tools/Ch-GUI/" class="md-nav__link">
        Graphical User Interface (GUI)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Security
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Security" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Security
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Ch-Security/" class="md-nav__link">
        Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Ch-SecretStore/" class="md-nav__link">
        Secret Store
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Ch-APIGateway/" class="md-nav__link">
        API Gateway
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Ch-Secure-MessageBus/" class="md-nav__link">
        Secure MessageBus
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Ch-Configuring-Add-On-Services/" class="md-nav__link">
        Configuring Add-on Service
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Ch-Secure-Consul/" class="md-nav__link">
        Secure Consul
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Ch-SecurityIssues/" class="md-nav__link">
        Reporting Security Issues
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Ch-AddGatewayUserRemotely/" class="md-nav__link">
        Adding EdgeX API Gateway Users Remotely
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../secrets-config/" class="md-nav__link">
        Secrets config
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../secrets-config-proxy/" class="md-nav__link">
        Secrets config proxy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../SeedingServiceSecrets/" class="md-nav__link">
        Seeding Service Secrets
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Ch-CORS-Settings/" class="md-nav__link">
        CORS settings
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Remote Device Services in Secure Mode
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Remote Device Services in Secure Mode
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#running-the-example" class="md-nav__link">
    Running the Example
  </a>
  
    <nav class="md-nav" aria-label="Running the Example">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#on-the-local-machine" class="md-nav__link">
    On the Local Machine
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on-the-remote-machine" class="md-nav__link">
    On the Remote Machine
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ssh-tunneling-explained" class="md-nav__link">
    SSH Tunneling Explained
  </a>
  
    <nav class="md-nav" aria-label="SSH Tunneling Explained">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#local-port-forwarding" class="md-nav__link">
    Local Port Forwarding
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-port-forwarding" class="md-nav__link">
    Remote Port Forwarding
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-edgex-secret-store-token" class="md-nav__link">
    Security: EdgeX Secret Store Token
  </a>
  
    <nav class="md-nav" aria-label="Security: EdgeX Secret Store Token">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#local-side" class="md-nav__link">
    Local side
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-side" class="md-nav__link">
    Remote side
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
    <nav class="md-nav" aria-label="Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-with-the-device-virtual-apis" class="md-nav__link">
    Test with the device-virtual APIs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Microservices
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Microservices" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Microservices
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/general/" class="md-nav__link">
        Cross Cutting Concerns
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Configuration & Registry
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Configuration & Registry" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Configuration & Registry
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/configuration/CommonConfiguration/" class="md-nav__link">
        Common Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/configuration/CommonCommandLineOptions/" class="md-nav__link">
        Common Command Line Options
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/configuration/CommonEnvironmentVariables/" class="md-nav__link">
        Common Environment Variables
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/configuration/ConfigurationAndRegistry/" class="md-nav__link">
        Configuration and Registry Providers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/configuration/V2MigrationCommonConfig/" class="md-nav__link">
        V2 Migration of Common Configuration
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3">
          Core Services
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Core Services" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Core Services
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/core/Ch-CoreServices/" class="md-nav__link">
        Core Services
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/core/data/Ch-CoreData/" class="md-nav__link">
        Core Data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/core/metadata/Ch-Metadata/" class="md-nav__link">
        Metadata
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/core/command/Ch-Command/" class="md-nav__link">
        Command
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/core/database/Ch-Redis/" class="md-nav__link">
        Redis Database
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_4">
          Supporting Services
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Supporting Services" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          Supporting Services
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/support/Ch-SupportingServices/" class="md-nav__link">
        Supporting Services Microservices
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/support/notifications/Ch-AlertsNotifications/" class="md-nav__link">
        Alerts & Notifications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/support/eKuiper/Ch-eKuiper/" class="md-nav__link">
        eKuiper Rules Engine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/support/scheduler/Ch-Scheduler/" class="md-nav__link">
        Scheduler
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_5" type="checkbox" id="__nav_4_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_5">
          System Management
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="System Management" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_5">
          <span class="md-nav__icon md-icon"></span>
          System Management
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/system-management/Ch_SystemManagement/" class="md-nav__link">
        System Management Micro Services
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/system-management/agent/Ch_SysMgmtAgent/" class="md-nav__link">
        System Management Agent (SMA)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/system-management/executor/Ch_SysMgmtExecutor/" class="md-nav__link">
        System Management Executor (SME)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_6" type="checkbox" id="__nav_4_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_6">
          Devices Services
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Devices Services" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_6">
          <span class="md-nav__icon md-icon"></span>
          Devices Services
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/device/Ch-DeviceServices/" class="md-nav__link">
        Device Services Microservices
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/device/Ch-DeviceServiceList/" class="md-nav__link">
        Device Service Support
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/device/profile/Ch-DeviceProfile/" class="md-nav__link">
        Device Profile
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/device/sdk/Ch-DeviceSDK/" class="md-nav__link">
        Device Services SDK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/device/virtual/Ch-VirtualDevice/" class="md-nav__link">
        Virtual Device
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/device/V2Migration/" class="md-nav__link">
        V2 Migration Guide
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_7" type="checkbox" id="__nav_4_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_7">
          Application Services
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Application Services" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_7">
          <span class="md-nav__icon md-icon"></span>
          Application Services
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/application/ApplicationServices/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/application/GettingStarted/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/application/Triggers/" class="md-nav__link">
        Triggers
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_7_4" type="checkbox" id="__nav_4_7_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_7_4">
          Application Functions SDK
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Application Functions SDK" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_7_4">
          <span class="md-nav__icon md-icon"></span>
          Application Functions SDK
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/application/ApplicationFunctionsSDK/" class="md-nav__link">
        App Functions SDK Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/application/ApplicationServiceAPI/" class="md-nav__link">
        Application Service API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/application/AppFunctionContextAPI/" class="md-nav__link">
        App Function Context API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/application/ErrorHandling/" class="md-nav__link">
        Pipeline Function Error Handling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/application/BuiltIn/" class="md-nav__link">
        Built-In Pipeline Functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/application/AdvancedTopics/" class="md-nav__link">
        Advanced Topics
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/application/AppServiceConfigurable/" class="md-nav__link">
        App Service Configurable
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/application/GeneralAppServiceConfig/" class="md-nav__link">
        Application Service Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/application/V2Migration/" class="md-nav__link">
        V2 Migration Guide
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Examples and Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Examples and Tutorials" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Examples and Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/" class="md-nav__link">
        EdgeX Examples
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/Ch-ExamplesVirtualDeviceService/" class="md-nav__link">
        Using the Virtual Device Service
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/Ch-ExamplesSendingAndConsumingBinary/" class="md-nav__link">
        Sending and Consuming Binary Data From EdgeX Device Services
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/AppServiceExamples/" class="md-nav__link">
        App Service Examples
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/Ch-CommandingDeviceThroughRulesEngine/" class="md-nav__link">
        Command Devices with eKuiper Rules Engine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/Ch-ExamplesModbusdatatypeconversion/" class="md-nav__link">
        Modbus - Data Type Conversion
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_7" type="checkbox" id="__nav_5_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_7">
          Adding a Device
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Adding a Device" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_7">
          <span class="md-nav__icon md-icon"></span>
          Adding a Device
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/Ch-ExamplesAddingModbusDevice/" class="md-nav__link">
        Modbus
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/Ch-ExamplesAddingSNMPDevice/" class="md-nav__link">
        SNMP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/Ch-ExamplesAddingMQTTDevice/" class="md-nav__link">
        MQTT
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_8" type="checkbox" id="__nav_5_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_8">
          Walkthrough
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Walkthrough" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_8">
          <span class="md-nav__icon md-icon"></span>
          Walkthrough
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../walk-through/Ch-Walkthrough/" class="md-nav__link">
        EdgeX Demonstration API Walk Through
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../walk-through/Ch-WalkthroughSetup/" class="md-nav__link">
        Setup up your environment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../walk-through/Ch-WalkthroughUseCase/" class="md-nav__link">
        Example Use Case
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../walk-through/Ch-WalkthroughDeviceProfile/" class="md-nav__link">
        Defining your device
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../walk-through/Ch-WalkthroughDeviceService/" class="md-nav__link">
        Register your device service
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../walk-through/Ch-WalkthroughProvision/" class="md-nav__link">
        Provision a device
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../walk-through/Ch-WalkthroughCommands/" class="md-nav__link">
        Calling commands
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../walk-through/Ch-WalkthroughReading/" class="md-nav__link">
        Sending events and reading data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../walk-through/Ch-WalkthroughExporting/" class="md-nav__link">
        Exporting your device data
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          API Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          API Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/Ch-APIIntroduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2" type="checkbox" id="__nav_6_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_2">
          Core
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Core" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_2">
          <span class="md-nav__icon md-icon"></span>
          Core
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/core/Ch-APICoreCommand/" class="md-nav__link">
        Core Command
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/core/Ch-APICoreData/" class="md-nav__link">
        Core Data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/core/Ch-APICoreMetadata/" class="md-nav__link">
        Core Metadata
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/core/Ch-APICoreConfigurationAndRegistry/" class="md-nav__link">
        Configuration and Registry
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_3" type="checkbox" id="__nav_6_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_3">
          Support
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Support" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_3">
          <span class="md-nav__icon md-icon"></span>
          Support
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/support/Ch-APISupportNotifications/" class="md-nav__link">
        Support Notifications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/support/Ch-APISupportScheduler/" class="md-nav__link">
        Support Scheduler
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4" type="checkbox" id="__nav_6_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_4">
          Management
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Management" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_4">
          <span class="md-nav__icon md-icon"></span>
          Management
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/management/Ch-APISystemManagement/" class="md-nav__link">
        System Management Agent
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_5" type="checkbox" id="__nav_6_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_5">
          Device
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Device" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_5">
          <span class="md-nav__icon md-icon"></span>
          Device
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/devices/Ch-APIDeviceSDK/" class="md-nav__link">
        Device Services
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_6" type="checkbox" id="__nav_6_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_6">
          Application
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Application" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_6">
          <span class="md-nav__icon md-icon"></span>
          Application
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/applications/Ch-APIAppFunctionsSDK/" class="md-nav__link">
        Application Services
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/applications/Ch-APIRulesEngine/" class="md-nav__link">
        Rules Engine
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Architectural Decision Records
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Architectural Decision Records" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Architectural Decision Records
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../design/" class="md-nav__link">
        Architecture Decision Records Folder
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../design/TOC/" class="md-nav__link">
        ADR Table of Contents
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_3" type="checkbox" id="__nav_7_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_3">
          Legacy
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Legacy" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_3">
          <span class="md-nav__icon md-icon"></span>
          Legacy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../design/legacy-design/" class="md-nav__link">
        Legacy Design Documents
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../design/legacy-requirements/" class="md-nav__link">
        Legacy Requirements
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../general/Definitions/" class="md-nav__link">
        Definitions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../general/PlatformRequirements/" class="md-nav__link">
        Platform Requirements
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../general/ServicePorts/" class="md-nav__link">
        Default Service Ports
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../general/ContainerNames/" class="md-nav__link">
        EdgeX Container Names
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../general/ServiceConfiguration/" class="md-nav__link">
        Service Configuration
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#running-the-example" class="md-nav__link">
    Running the Example
  </a>
  
    <nav class="md-nav" aria-label="Running the Example">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#on-the-local-machine" class="md-nav__link">
    On the Local Machine
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on-the-remote-machine" class="md-nav__link">
    On the Remote Machine
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ssh-tunneling-explained" class="md-nav__link">
    SSH Tunneling Explained
  </a>
  
    <nav class="md-nav" aria-label="SSH Tunneling Explained">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#local-port-forwarding" class="md-nav__link">
    Local Port Forwarding
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-port-forwarding" class="md-nav__link">
    Remote Port Forwarding
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-edgex-secret-store-token" class="md-nav__link">
    Security: EdgeX Secret Store Token
  </a>
  
    <nav class="md-nav" aria-label="Security: EdgeX Secret Store Token">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#local-side" class="md-nav__link">
    Local side
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-side" class="md-nav__link">
    Remote side
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
    <nav class="md-nav" aria-label="Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-with-the-device-virtual-apis" class="md-nav__link">
    Test with the device-virtual APIs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/edgexfoundry/edgex-go/edit/master/docs/security/Ch-RemoteDeviceServices.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="remote-device-services-in-secure-mode">Remote Device Services in Secure Mode</h1>
<p>This page describes the remote device service example in the
<code>edgex-examples</code> GitHub repository.</p>
<p>Running a remote device service poses several problems
when EdgeX is running in secure mode:</p>
<ul>
<li>
<p>Network traffic between the primary EdgeX node and the remote
  device service node is unencrypted.</p>
</li>
<li>
<p>The remote device service will not have a Consul authentication token
  that allows it to talk to the registry and configuration services.</p>
</li>
<li>
<p>The remote device service will not have a secret store token that
  allows access to the EdgeX secret store (which is also needed to
  obtain a Consul authentication token).</p>
</li>
</ul>
<p>This example will resolve the above complications by</p>
<ol>
<li>
<p>Creating secure SSH network tunnel between nodes to encrypt
   network communication.</p>
</li>
<li>
<p>Use the delayed start feature introduced in EdgeX Kamakura to
   lasily obtain a secret store token that will grant the device
   service access to the EdgeX secret store, EdgeX registry service,
   and EdgeX configuration service.</p>
</li>
</ol>
<h2 id="running-the-example">Running the Example</h2>
<p>First, clone the <code>edgex-examples repository</code>, checkout <code>v2.2.0</code> and change to the
<code>security/remote_devices/spiffe_and_ssh</code> directory.</p>
<p>Next, run the <code>generate_keys.sh</code> script to generate an SSH
keypair for the SSH tunnel.
This keypair is used only for the SSH tunnel
and should have no other privileges.</p>
<p>Once the <code>generate_keys.sh</code> script has been run,
copy the <code>remote</code> folder to the remote device service machine.</p>
<h3 id="on-the-local-machine">On the Local Machine</h3>
<p>Change directories to the <code>local</code> folder.</p>
<p>Edit <code>docker-compose.yml</code> and change the <code>TUNNEL_HOST</code>
environment variable to the IP address of the remote node.</p>
<p>Run</p>
<div class="highlight"><pre><span></span><code>$ docker-compose build
$ docker-compose up -d
</code></pre></div>
<p>After the framework has been built and is running,
check the <code>device-ssh-proxy</code> service</p>
<div class="highlight"><pre><span></span><code>$ docker ps -a <span class="p">|</span> grep device-ssh-proxy
a92ff2d6999c device-ssh-proxy:latest <span class="s2">&quot;/edgex-init&quot;</span>   <span class="m">2</span> minutes ago   Restarting <span class="o">(</span><span class="m">1</span><span class="o">)</span> <span class="m">16</span> seconds ago edgex-device-ssh-proxy
$ docker logs device-ssh-proxy
+ scp -p -o <span class="s1">&#39;StrictHostKeyChecking=no&#39;</span> -o <span class="s1">&#39;UserKnownHostsFile=/dev/null&#39;</span> -P <span class="m">2223</span> /srv/spiffe/remote-agent/agent.key <span class="m">192</span>.168.122.193:/srv/spiffe/remote-agent/agent.key
ssh: connect to host <span class="m">192</span>.168.122.193 port <span class="m">2223</span>: Connection refused
lost connection
</code></pre></div>
<p>The SSH connection will continue to fail until the remote node is brought up.</p>
<p>Next, authorize the workload running on the remote node.</p>
<div class="highlight"><pre><span></span><code>$ ./add-server-entry.sh
Entry ID         : f62bfec6-b19c-43ea-94b8-975f7e9a258e
SPIFFE ID        : spiffe://edgexfoundry.org/service/device-virtual
Parent ID        : spiffe://edgexfoundry.org/spire/agent/x509pop/cn/remote-agent
Revision         : <span class="m">0</span>
TTL              : default
Selector         : docker:label:com.docker.compose.service:device-virtual
DNS name         : edgex-device-virtual
</code></pre></div>
<p>That is all to be done on the local node.</p>
<h3 id="on-the-remote-machine">On the Remote Machine</h3>
<p>Change directories to the <code>remote</code> folder and run</p>
<div class="highlight"><pre><span></span><code>$ docker-compose build
$ docker-compose up -d
</code></pre></div>
<p>After the framework has been built and is running for about a minute,
check the <code>device-virtual</code> service</p>
<div class="highlight"><pre><span></span><code>$ docker logs -f edgex-device-virtual
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.005673094Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>config.go:391 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Loaded service configuration from ./res/configuration.toml&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.006211643Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>variables.go:352 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Variables override of &#39;SecretStore.RuntimeTokenProvider.Port&#39; by environment variable: SECRETSTORE_RUNTIMETOKENPROVIDER_PORT=59841&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.006286584Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>variables.go:352 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Variables override of &#39;SecretStore.RuntimeTokenProvider.Protocol&#39; by environment variable: SECRETSTORE_RUNTIMETOKENPROVIDER_PROTOCOL=https&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.006341968Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>variables.go:352 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Variables override of &#39;Clients.core-metadata.Host&#39; by environment variable: CLIENTS_CORE_METADATA_HOST=edgex-core-metadata&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.006382102Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>variables.go:352 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Variables override of &#39;MessageQueue.Host&#39; by environment variable: MESSAGEQUEUE_HOST=edgex-redis&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.006416098Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>variables.go:352 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Variables override of &#39;SecretStore.RuntimeTokenProvider.EndpointSocket&#39; by environment variable: SECRETSTORE_RUNTIMETOKENPROVIDER_ENDPOINTSOCKET=/tmp/edgex/secrets/spiffe/public/api.sock&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.006457406Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>variables.go:352 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Variables override of &#39;SecretStore.RuntimeTokenProvider.RequiredSecrets&#39; by environment variable: SECRETSTORE_RUNTIMETOKENPROVIDER_REQUIREDSECRETS=redisdb&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.006495791Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>variables.go:352 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Variables override of &#39;SecretStore.RuntimeTokenProvider.Enabled&#39; by environment variable: SECRETSTORE_RUNTIMETOKENPROVIDER_ENABLED=true&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.006529808Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>variables.go:352 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Variables override of &#39;SecretStore.RuntimeTokenProvider.Host&#39; by environment variable: SECRETSTORE_RUNTIMETOKENPROVIDER_HOST=edgex-security-spiffe-token-provider&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.006575741Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>variables.go:352 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Variables override of &#39;Clients.core-data.Host&#39; by environment variable: CLIENTS_CORE_DATA_HOST=edgex-core-data&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.006617026Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>variables.go:352 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Variables override of &#39;SecretStore.Host&#39; by environment variable: SECRETSTORE_HOST=edgex-vault&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.006650922Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>variables.go:352 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Variables override of &#39;SecretStore.Port&#39; by environment variable: SECRETSTORE_PORT=8200&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.006691769Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>variables.go:352 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Variables override of &#39;SecretStore.RuntimeTokenProvider.TrustDomain&#39; by environment variable: SECRETSTORE_RUNTIMETOKENPROVIDER_TRUSTDOMAIN=edgexfoundry.org&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.006729711Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>variables.go:352 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Variables override of &#39;Service.Host&#39; by environment variable: SERVICE_HOST=edgex-device-virtual&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.006764754Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>variables.go:352 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Variables override of &#39;Registry.Host&#39; by environment variable: REGISTRY_HOST=edgex-core-consul&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.006904867Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>secret.go:55 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Creating SecretClient&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.006953018Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>secret.go:62 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Reading secret store configuration and authentication token&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.006994824Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>secret.go:165 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;runtime token provider enabled&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:28:30.007064786Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>methods.go:138 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;using Unix Domain Socket at unix:///tmp/edgex/secrets/spiffe/public/api.sock&quot;</span>
</code></pre></div>
<p>If the workload was not authorized on the local side,
the output will stop as shown above.
The service would be hung waiting for a SPIFFE authentication token.</p>
<p>Since the local site was stuck in a retry loop trying to establish an
SSH connection to the remote, the service may stay stuck in this state
for several minutes until the network tunnels are established.</p>
<p>Otherwise the log would continue as follows:</p>
<div class="highlight"><pre><span></span><code><span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.078483584Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>methods.go:150 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;workload got X509 source&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.168325689Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>methods.go:120 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;successfully got token from spiffe-token-provider!&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.169095621Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>secret.go:80 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Attempting to create secret client&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.172259336Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>secret.go:91 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Created SecretClient&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.172359472Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>secret.go:96 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;SecretsFile not set, skipping seeding of service secrets.&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.172539631Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>secrets.go:276 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;kick off token renewal with interval: 30m0s&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.172433598Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>config.go:551 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Using local configuration from file (14 envVars overrides applied)&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.172916142Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>httpserver.go:131 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Web server starting (edgex-device-virtual:59900)&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.172948285Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>messaging.go:69 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Setting options for secure MessageBus with AuthMode=&#39;usernamepassword&#39; and SecretName=&#39;redisdb&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.174321296Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>messaging.go:97 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Connected to redis Message Bus @ redis://edgex-redis:6379 publishing on &#39;edgex/events/device&#39; prefix topic with AuthMode=&#39;usernamepassword&#39;&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.174585076Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>init.go:135 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Check core-metadata service&#39;s status by ping...&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.176202842Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>init.go:54 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Service clients initialize successful.&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.176377929Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>clients.go:124 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Using configuration for URL for &#39;core-metadata&#39;: http://edgex-core-metadata:59881&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.176559116Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>clients.go:124 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Using configuration for URL for &#39;core-data&#39;: http://edgex-core-data:59880&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.176806351Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>restrouter.go:55 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Registering v2 routes...&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.192658275Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>service.go:230 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;device service device-virtual exists, updating it&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.195403199Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>profiles.go:54 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Loading pre-defined profiles from /res/profiles&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.197297762Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>profiles.go:88 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Profile Random-Binary-Device exists, using the existing one&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.240099318Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>profiles.go:88 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Profile Random-Boolean-Device exists, using the existing one&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.24221092Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>profiles.go:88 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Profile Random-Float-Device exists, using the existing one&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.245516797Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>profiles.go:88 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Profile Random-Integer-Device exists, using the existing one&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.250310838Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>profiles.go:88 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Profile Random-UnsignedInteger-Device exists, using the existing one&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.250961547Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>devices.go:49 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Loading pre-defined devices from /res/devices&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.252216571Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>devices.go:85 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Device Random-Boolean-Device exists, using the existing one&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.252274853Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>devices.go:85 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Device Random-Integer-Device exists, using the existing one&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.252290321Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>devices.go:85 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Device Random-UnsignedInteger-Device exists, using the existing one&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.252297541Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>devices.go:85 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Device Random-Float-Device exists, using the existing one&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.252304305Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>devices.go:85 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Device Random-Binary-Device exists, using the existing one&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.252698155Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>autodiscovery.go:33 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;AutoDiscovery stopped: disabled by configuration&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.252726349Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>autodiscovery.go:42 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;AutoDiscovery stopped: ProtocolDiscovery not implemented&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.252736451Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>message.go:50 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Service dependencies resolved...&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.252804946Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>message.go:51 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Starting device-virtual 2.2.0-dev.15 &quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.252817404Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>message.go:55 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;device virtual started&quot;</span>
<span class="nv">level</span><span class="o">=</span>INFO <span class="nv">ts</span><span class="o">=</span><span class="m">2022</span>-05-05T14:29:25.252880346Z <span class="nv">app</span><span class="o">=</span>device-virtual <span class="nv">source</span><span class="o">=</span>message.go:58 <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Service started in: 55.248960914s&quot;</span>
</code></pre></div>
<p>At this point, the remote device service is up and running in secure mode.</p>
<h2 id="ssh-tunneling-explained">SSH Tunneling Explained</h2>
<p>In this example, SSH port forwarding is used to establish an encrypted network channel
between the local and remote nodes.
The local machine as the primary host is running the whole EdgeX core services including core services and security services but <strong>without</strong> any device service.
The device services are running on the remote machine.  </p>
<p>The SSH communication is established by introducing some extra SSH-related services:</p>
<p>1) <code>device-ssh-proxy</code>.  This service runs on the local machine an is an SSH client that initiates communication with the remote node.  The <code>device-ssh-proxy</code> service has the private key needed to establish the network connection and also authorizes the network tunnels.</p>
<p>2) <code>sshd-remote</code>.  This service runs on the remote machine and provides an SSH server for the purposes of establishing network communcation with the remote device service.</p>
<p>Running <code>sshd</code> in Docker is a container anti-pattern,
as one can enter a container for remote administration
using <code>docker exec</code>.
In this use case, however,
we are not using <code>sshd</code> for remote administration,
but instead to set up a network tunnel.</p>
<p>For an example of how to run a SSH server in Docker, checkout <a href="https://docs.docker.com/engine/examples/running_ssh_service/">https://docs.docker.com/engine/examples/running_ssh_service/</a> for detailed instructions.</p>
<p>The <code>generate-keys.sh</code> helper script generates an RSA keypair,
and copies the <code>authorized_keys</code> file into the
<code>remote/sshd-remote</code> folder.
The sample's <code>Dockerfile</code> will then build this key into the the
remote <code>sshd</code> container image and use it for authentication.
The private key remains on the local machine and is bind-mounted
to the host from the <code>device-ssh-proxy</code> service.</p>
<h3 id="local-port-forwarding">Local Port Forwarding</h3>
<p>In this use case, we want to impersonate a device service
that is running on a remote machine.
We use local port forwarding to receive inbound requests
on the device service's port,
and ask that the traffic be forwarded
through the ssh tunnel
to a remote host and a remote port.
The -L flag of ssh command is important here.</p>
<div class="highlight"><pre><span></span><code>  ssh -N <span class="se">\</span>
    -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no <span class="se">\</span>
    -o <span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null <span class="se">\</span>
    -L *:<span class="nv">$SERVICE_PORT</span>:<span class="nv">$SERVICE_HOST</span>:<span class="nv">$SERVICE_PORT</span> <span class="se">\</span>
    -p <span class="nv">$TUNNEL_SSH_PORT</span> <span class="se">\</span>
    <span class="nv">$TUNNEL_HOST</span> 
</code></pre></div>
<p>where environment variables are:</p>
<ul>
<li>
<p><code>TUNNEL_HOST</code> is the remote host name or IP address that SSH daemon or server is running on;</p>
</li>
<li>
<p><code>TUNNEL_SSH_PROT</code> is the port number to be used on the SSH tunnel communication between the local machine and the remote machine</p>
</li>
<li>
<p><code>SERVICE_PORT</code> is the port number from the local or the primary to be forwared to the remote machine; without lose of generality, the port number on the remote machine is the same as the local one</p>
</li>
<li>
<p><code>SERVICE_HOST</code> is the service host name or IP address of the Docker containers that are running on the remote machine</p>
</li>
</ul>
<p>In order to make the other containers aware of the port forwarding,
the <code>docker-compose.yml</code> is configured to so that the <code>device-ssh-proxy</code> service
impersonates <code>edgex-device-virtual</code> on the local docker network.</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nt">device-ssh-proxy</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">device-ssh-proxy:latest</span><span class="w"></span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">edgex-network</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">aliases</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">edgex-device-virtual</span><span class="w"></span>
</code></pre></div>
<p>The port-forwarding is transparent to the EdgeX services running on the local machine.</p>
<h3 id="remote-port-forwarding">Remote Port Forwarding</h3>
<p>This step is to show the reverse direction of SSH tunneling: from the remote back to the local machine.</p>
<p>The reverse SSH tunneling is also needed because the device services depends on the core services like <code>core-data</code>, <code>core-metadata</code>, Redis (for message queuing), Vault (for the secret store), and Consul (for registry and configuration).
These core services are running on the local machine and should be <strong>reverse</strong> tunneled back from the remote machine.
Essentially, the <code>sshd</code> container will impersonate these services
on the remote side.
This can be achieved by using <code>-R</code> flag of ssh command.
Extending the previous example:</p>
<div class="highlight"><pre><span></span><code>  ssh -N <span class="se">\</span>
    -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no <span class="se">\</span>
    -o <span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null <span class="se">\</span>
    -L *:<span class="nv">$SERVICE_PORT</span>:<span class="nv">$SERVICE_HOST</span>:<span class="nv">$SERVICE_PORT</span> <span class="se">\</span>
    -R <span class="m">0</span>.0.0.0:<span class="nv">$SECRETSTORE_PORT</span>:<span class="nv">$SECRETSTORE_HOST</span>:<span class="nv">$SECRETSTORE_PORT</span> <span class="se">\</span>
    -R <span class="m">0</span>.0.0.0:6379:<span class="nv">$MESSAGEQUEUE_HOST</span>:6379 <span class="se">\</span>
    -R <span class="m">0</span>.0.0.0:8500:<span class="nv">$REGISTRY_HOST</span>:8500 <span class="se">\</span>
    -R <span class="m">0</span>.0.0.0:5563:<span class="nv">$CLIENTS_CORE_DATA_HOST</span>:5563 <span class="se">\</span>
    -R <span class="m">0</span>.0.0.0:59880:<span class="nv">$CLIENTS_CORE_DATA_HOST</span>:59880 <span class="se">\</span>
    -R <span class="m">0</span>.0.0.0:59881:<span class="nv">$CLIENTS_CORE_METADATA_HOST</span>:59881 <span class="se">\</span>
    -R <span class="m">0</span>.0.0.0:<span class="nv">$SECURITY_SPIRE_SERVER_PORT</span>:<span class="nv">$SECURITY_SPIRE_SERVER_HOST</span>:<span class="nv">$SECURITY_SPIRE_SERVER_PORT</span> <span class="se">\</span>
    -R <span class="m">0</span>.0.0.0:<span class="nv">$SECRETSTORE_RUNTIMETOKENPROVIDER_PORT</span>:<span class="nv">$SECRETSTORE_RUNTIMETOKENPROVIDER_HOST</span>:<span class="nv">$SECRETSTORE_RUNTIMETOKENPROVIDER_PORT</span> <span class="se">\</span>
    -p <span class="nv">$TUNNEL_SSH_PORT</span> <span class="se">\</span>
    <span class="nv">$TUNNEL_HOST</span> 
</code></pre></div>
<p>As was done on the local side, the remote side does in reverse,
masquerading on the network as the core services needed by
device services:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nt">sshd-remote</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">edgex-sshd-remote:latest</span><span class="w"></span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">edgex-network</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">aliases</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">edgex-core-consul</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">edgex-core-data</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">edgex-core-metadata</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">edgex-redis</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">edgex-security-spire-server</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">edgex-security-spiffe-token-provider</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">edgex-vault</span><span class="w"></span>
</code></pre></div>
<h2 id="security-edgex-secret-store-token">Security: EdgeX Secret Store Token</h2>
<p>Beyond port forwarding,
extra steps need to be taken to enable the remote device service
to use SPIFFE/SPIRE to obtain a token for the EdgeX secret store.</p>
<h3 id="local-side">Local side</h3>
<p>On the local machine side, the <code>device-ssh-proxy</code> service has
some initialization code inserted into its entrypoint script.
It is done this way to facilitate ease-of-use for the example.
In a production deployment this should be done out-of-band.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Wait for agent CA creation</span>

<span class="k">while</span> <span class="nb">test</span> ! -f <span class="s2">&quot;/srv/spiffe/ca/public/agent-ca.crt&quot;</span><span class="p">;</span> <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for /srv/spiffe/ca/public/agent-ca.crt&quot;</span>
    sleep <span class="m">1</span>
<span class="k">done</span>

<span class="c1"># Pre-create remote agent certificate</span>

<span class="k">if</span> <span class="nb">test</span> ! -f <span class="s2">&quot;/srv/spiffe/remote-agent/agent.crt&quot;</span><span class="p">;</span> <span class="k">then</span>
    openssl ecparam -genkey -name secp521r1 -noout -out <span class="s2">&quot;/srv/spiffe/remote-agent/agent.key&quot;</span>
    <span class="nv">SAN</span><span class="o">=</span><span class="s2">&quot;&quot;</span> openssl req -subj <span class="s2">&quot;/CN=remote-agent&quot;</span> -config <span class="s2">&quot;/usr/local/etc/openssl.conf&quot;</span> -key <span class="s2">&quot;/srv/spiffe/remote-agent/agent.key&quot;</span> -sha512 -new -out <span class="s2">&quot;/run/agent.req.</span><span class="nv">$$</span><span class="s2">&quot;</span>
    <span class="nv">SAN</span><span class="o">=</span><span class="s2">&quot;&quot;</span> openssl x509 -sha512 -extfile /usr/local/etc/openssl.conf -extensions agent_ext -CA <span class="s2">&quot;/srv/spiffe/ca/public/agent-ca.crt&quot;</span> -CAkey <span class="s2">&quot;/srv/spiffe/ca/private/agent-ca.key&quot;</span> -CAcreateserial -req -in <span class="s2">&quot;/run/agent.req.</span><span class="nv">$$</span><span class="s2">&quot;</span> -days <span class="m">3650</span> -out <span class="s2">&quot;/srv/spiffe/remote-agent/agent.crt&quot;</span>
    rm -f <span class="s2">&quot;/run/agent.req.</span><span class="nv">$$</span><span class="s2">&quot;</span>
<span class="k">fi</span>


<span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
  scp -p <span class="se">\</span>
    -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no <span class="se">\</span>
    -o <span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null <span class="se">\</span>
    -P <span class="nv">$TUNNEL_SSH_PORT</span> <span class="se">\</span>
    /srv/spiffe/remote-agent/agent.key <span class="nv">$TUNNEL_HOST</span>:/srv/spiffe/remote-agent/agent.key
  scp -p <span class="se">\</span>
    -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no <span class="se">\</span>
    -o <span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null <span class="se">\</span>
    -P <span class="nv">$TUNNEL_SSH_PORT</span> <span class="se">\</span>
    /srv/spiffe/remote-agent/agent.crt <span class="nv">$TUNNEL_HOST</span>:/srv/spiffe/remote-agent/agent.crt
  scp -p <span class="se">\</span>
    -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no <span class="se">\</span>
    -o <span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null <span class="se">\</span>
    -P <span class="nv">$TUNNEL_SSH_PORT</span> <span class="se">\</span>
    /tmp/edgex/secrets/spiffe/trust/bundle <span class="nv">$TUNNEL_HOST</span>:/tmp/edgex/secrets/spiffe/trust/bundle    
  ssh <span class="se">\</span>
    -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no <span class="se">\</span>
    -o <span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null <span class="se">\</span>
    -p <span class="nv">$TUNNEL_SSH_PORT</span> <span class="se">\</span>
    <span class="nv">$TUNNEL_HOST</span> -- <span class="se">\</span>
    chown -Rh <span class="m">2002</span>:2001 /tmp/edgex/secrets/spiffe

  ...
</code></pre></div>
<p>The one-time setup is generating a new agent key from the agent
CA certificate.  This will enable the SPIRE server to trust the new agent.
There is also automation to copy the certificate and private key
to the remote node as part of SSH session establishment.
This entire flow could be done as an out-of-band process.</p>
<p>The last part, which is to copy the current trust bundle
to the remote node as part of SSH session establishment,
should be left as-is, as the trust bundle is on a temp
file system and might be cleaned between reboots.</p>
<h3 id="remote-side">Remote side</h3>
<p>On the remote side, the SPIRE agent looks mostly like
the local side SPIRE agent, except that the paths are different,
and there is a delay loop waiting for the agent key and certificate
to be copied to the node via the above process.</p>
<p>The requirements for the remote side are:</p>
<ul>
<li>
<p>The SPIRE server must be able to establish trust in the agent.
  There are many mechanisms available to do this.
  The example uses a public key infrastructure to establish trust.</p>
</li>
<li>
<p>The SPIRE agent must have network connectivity with the SPIRE server.
  This is provided by the SSH reverse proxy tunnel.</p>
</li>
</ul>
<h2 id="testing">Testing</h2>
<h3 id="test-with-the-device-virtual-apis">Test with the device-virtual APIs</h3>
<p>The easiest way to test the setup is to make a call
from the local machine to the remote <code>device-virtual</code> service:</p>
<div class="highlight"><pre><span></span><code>$ curl -s http://127.0.0.1:59900/api/v2/config <span class="p">|</span> jq
<span class="o">{</span>
  <span class="s2">&quot;apiVersion&quot;</span>: <span class="s2">&quot;v2&quot;</span>,
  <span class="s2">&quot;config&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;Writable&quot;</span>: <span class="o">{</span>
      <span class="s2">&quot;LogLevel&quot;</span>: <span class="s2">&quot;INFO&quot;</span>,
      <span class="s2">&quot;InsecureSecrets&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;DB&quot;</span>: <span class="o">{</span>
          <span class="s2">&quot;Path&quot;</span>: <span class="s2">&quot;redisdb&quot;</span>,
          <span class="s2">&quot;Secrets&quot;</span>: <span class="o">{</span>
            <span class="s2">&quot;password&quot;</span>: <span class="s2">&quot;&quot;</span>,
            <span class="s2">&quot;username&quot;</span>: <span class="s2">&quot;&quot;</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>,
      <span class="s2">&quot;Reading&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;ReadingUnits&quot;</span>: <span class="nb">true</span>
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="s2">&quot;Clients&quot;</span>: <span class="o">{</span>
      <span class="s2">&quot;core-data&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;Host&quot;</span>: <span class="s2">&quot;edgex-core-data&quot;</span>,
        <span class="s2">&quot;Port&quot;</span>: <span class="m">59880</span>,
        <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;http&quot;</span>
      <span class="o">}</span>,
      <span class="s2">&quot;core-metadata&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;Host&quot;</span>: <span class="s2">&quot;edgex-core-metadata&quot;</span>,
        <span class="s2">&quot;Port&quot;</span>: <span class="m">59881</span>,
        <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;http&quot;</span>
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="s2">&quot;Registry&quot;</span>: <span class="o">{</span>
      <span class="s2">&quot;Host&quot;</span>: <span class="s2">&quot;edgex-core-consul&quot;</span>,
      <span class="s2">&quot;Port&quot;</span>: <span class="m">8500</span>,
      <span class="s2">&quot;Type&quot;</span>: <span class="s2">&quot;consul&quot;</span>
    <span class="o">}</span>,
    <span class="s2">&quot;Service&quot;</span>: <span class="o">{</span>
      <span class="s2">&quot;HealthCheckInterval&quot;</span>: <span class="s2">&quot;10s&quot;</span>,
      <span class="s2">&quot;Host&quot;</span>: <span class="s2">&quot;edgex-device-virtual&quot;</span>,
      <span class="s2">&quot;Port&quot;</span>: <span class="m">59900</span>,
      <span class="s2">&quot;ServerBindAddr&quot;</span>: <span class="s2">&quot;&quot;</span>,
      <span class="s2">&quot;StartupMsg&quot;</span>: <span class="s2">&quot;device virtual started&quot;</span>,
      <span class="s2">&quot;MaxResultCount&quot;</span>: <span class="m">0</span>,
      <span class="s2">&quot;MaxRequestSize&quot;</span>: <span class="m">0</span>,
      <span class="s2">&quot;RequestTimeout&quot;</span>: <span class="s2">&quot;5s&quot;</span>,
      <span class="s2">&quot;CORSConfiguration&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;EnableCORS&quot;</span>: false,
        <span class="s2">&quot;CORSAllowCredentials&quot;</span>: false,
        <span class="s2">&quot;CORSAllowedOrigin&quot;</span>: <span class="s2">&quot;https://localhost&quot;</span>,
        <span class="s2">&quot;CORSAllowedMethods&quot;</span>: <span class="s2">&quot;GET, POST, PUT, PATCH, DELETE&quot;</span>,
        <span class="s2">&quot;CORSAllowedHeaders&quot;</span>: <span class="s2">&quot;Authorization, Accept, Accept-Language, Content-Language, Content-Type, X-Correlation-ID&quot;</span>,
        <span class="s2">&quot;CORSExposeHeaders&quot;</span>: <span class="s2">&quot;Cache-Control, Content-Language, Content-Length, Content-Type, Expires, Last-Modified, Pragma, X-Correlation-ID&quot;</span>,
        <span class="s2">&quot;CORSMaxAge&quot;</span>: <span class="m">3600</span>
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="s2">&quot;Device&quot;</span>: <span class="o">{</span>
      <span class="s2">&quot;DataTransform&quot;</span>: true,
      <span class="s2">&quot;MaxCmdOps&quot;</span>: <span class="m">128</span>,
      <span class="s2">&quot;MaxCmdValueLen&quot;</span>: <span class="m">256</span>,
      <span class="s2">&quot;ProfilesDir&quot;</span>: <span class="s2">&quot;./res/profiles&quot;</span>,
      <span class="s2">&quot;DevicesDir&quot;</span>: <span class="s2">&quot;./res/devices&quot;</span>,
      <span class="s2">&quot;UpdateLastConnected&quot;</span>: false,
      <span class="s2">&quot;Discovery&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;Enabled&quot;</span>: false,
        <span class="s2">&quot;Interval&quot;</span>: <span class="s2">&quot;30s&quot;</span>
      <span class="o">}</span>,
      <span class="s2">&quot;AsyncBufferSize&quot;</span>: <span class="m">16</span>,
      <span class="s2">&quot;EnableAsyncReadings&quot;</span>: true,
      <span class="s2">&quot;Labels&quot;</span>: <span class="o">[]</span>,
      <span class="s2">&quot;UseMessageBus&quot;</span>: <span class="nb">true</span>
    <span class="o">}</span>,
    <span class="s2">&quot;Driver&quot;</span>: <span class="o">{}</span>,
    <span class="s2">&quot;SecretStore&quot;</span>: <span class="o">{</span>
      <span class="s2">&quot;Type&quot;</span>: <span class="s2">&quot;vault&quot;</span>,
      <span class="s2">&quot;Host&quot;</span>: <span class="s2">&quot;edgex-vault&quot;</span>,
      <span class="s2">&quot;Port&quot;</span>: <span class="m">8200</span>,
      <span class="s2">&quot;Path&quot;</span>: <span class="s2">&quot;device-virtual/&quot;</span>,
      <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;http&quot;</span>,
      <span class="s2">&quot;Namespace&quot;</span>: <span class="s2">&quot;&quot;</span>,
      <span class="s2">&quot;RootCaCertPath&quot;</span>: <span class="s2">&quot;&quot;</span>,
      <span class="s2">&quot;ServerName&quot;</span>: <span class="s2">&quot;&quot;</span>,
      <span class="s2">&quot;Authentication&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;AuthType&quot;</span>: <span class="s2">&quot;X-Vault-Token&quot;</span>,
        <span class="s2">&quot;AuthToken&quot;</span>: <span class="s2">&quot;&quot;</span>
      <span class="o">}</span>,
      <span class="s2">&quot;TokenFile&quot;</span>: <span class="s2">&quot;/tmp/edgex/secrets/device-virtual/secrets-token.json&quot;</span>,
      <span class="s2">&quot;SecretsFile&quot;</span>: <span class="s2">&quot;&quot;</span>,
      <span class="s2">&quot;DisableScrubSecretsFile&quot;</span>: false,
      <span class="s2">&quot;RuntimeTokenProvider&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;Enabled&quot;</span>: true,
        <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;https&quot;</span>,
        <span class="s2">&quot;Host&quot;</span>: <span class="s2">&quot;edgex-security-spiffe-token-provider&quot;</span>,
        <span class="s2">&quot;Port&quot;</span>: <span class="m">59841</span>,
        <span class="s2">&quot;TrustDomain&quot;</span>: <span class="s2">&quot;edgexfoundry.org&quot;</span>,
        <span class="s2">&quot;EndpointSocket&quot;</span>: <span class="s2">&quot;/tmp/edgex/secrets/spiffe/public/api.sock&quot;</span>,
        <span class="s2">&quot;RequiredSecrets&quot;</span>: <span class="s2">&quot;redisdb&quot;</span>
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="s2">&quot;MessageQueue&quot;</span>: <span class="o">{</span>
      <span class="s2">&quot;Type&quot;</span>: <span class="s2">&quot;redis&quot;</span>,
      <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;redis&quot;</span>,
      <span class="s2">&quot;Host&quot;</span>: <span class="s2">&quot;edgex-redis&quot;</span>,
      <span class="s2">&quot;Port&quot;</span>: <span class="m">6379</span>,
      <span class="s2">&quot;PublishTopicPrefix&quot;</span>: <span class="s2">&quot;edgex/events/device&quot;</span>,
      <span class="s2">&quot;SubscribeTopic&quot;</span>: <span class="s2">&quot;&quot;</span>,
      <span class="s2">&quot;AuthMode&quot;</span>: <span class="s2">&quot;usernamepassword&quot;</span>,
      <span class="s2">&quot;SecretName&quot;</span>: <span class="s2">&quot;redisdb&quot;</span>,
      <span class="s2">&quot;Optional&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;AutoReconnect&quot;</span>: <span class="s2">&quot;true&quot;</span>,
        <span class="s2">&quot;ClientId&quot;</span>: <span class="s2">&quot;device-virtual&quot;</span>,
        <span class="s2">&quot;ConnectTimeout&quot;</span>: <span class="s2">&quot;5&quot;</span>,
        <span class="s2">&quot;KeepAlive&quot;</span>: <span class="s2">&quot;10&quot;</span>,
        <span class="s2">&quot;Password&quot;</span>: <span class="s2">&quot;(redacted)&quot;</span>,
        <span class="s2">&quot;Qos&quot;</span>: <span class="s2">&quot;0&quot;</span>,
        <span class="s2">&quot;Retained&quot;</span>: <span class="s2">&quot;false&quot;</span>,
        <span class="s2">&quot;SkipCertVerify&quot;</span>: <span class="s2">&quot;false&quot;</span>,
        <span class="s2">&quot;Username&quot;</span>: <span class="s2">&quot;redis5&quot;</span>
      <span class="o">}</span>,
      <span class="s2">&quot;SubscribeEnabled&quot;</span>: <span class="nb">false</span>
    <span class="o">}</span>,
    <span class="s2">&quot;MaxEventSize&quot;</span>: <span class="m">0</span>
  <span class="o">}</span>,
  <span class="s2">&quot;serviceName&quot;</span>: <span class="s2">&quot;device-virtual&quot;</span>
<span class="o">}</span>
</code></pre></div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../Ch-CORS-Settings/" class="md-footer__link md-footer__link--prev" aria-label="Previous: CORS settings" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              CORS settings
            </div>
          </div>
        </a>
      
      
        
        <a href="../../microservices/general/" class="md-footer__link md-footer__link--next" aria-label="Next: Cross Cutting Concerns" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Cross Cutting Concerns
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 EdgeX Foundry
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/edgexfoundry" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/edgexfoundry" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://www.linkedin.com/company/edgexfoundry" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs"], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.a6c66575.min.js"></script>
      
        <script src="../../assets/javascripts/version-select.js"></script>
      
    
  </body>
</html>